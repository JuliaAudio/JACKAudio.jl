# Documentation: http://docs.travis-ci.com/user/languages/julia/
language: julia
# os:
#   - linux
  # - osx
notifications:
  email: false
sudo: required
matrix:
  include:
    - julia: 0.4
      os: linux
      env:
        - JACKD=1
      addons:
        apt:
          packages:
            - jackd1
    - julia: 0.4
      os: linux
      env:
        - JACKD=2
      addons:
        apt:
          packages:
            - jackd2
    - julia: nightly
      os: linux
      env:
        - JACKD=1
      addons:
        apt:
          packages:
            - jackd1
    - julia: nightly
      os: linux
      env:
        - JACKD=2
      addons:
        apt:
          packages:
            - jackd2
script:
 - if [[ -a .git/shallow ]]; then git fetch --unshallow; fi
 # build prlimit
 - |
  set -e
  pushd $PWD
  wget https://www.kernel.org/pub/linux/utils/util-linux/v2.25/util-linux-2.25.2.tar.gz
  tar -xzvf util-linux-2.25.2.tar.gz > /dev/null
  cd util-linux-2.25.2
  ./configure ADJTIME_PATH=/var/lib/hwclock/adjtime --disable-chfn-chsh --disable-login --disable-nologin --disable-su --disable-setpriv --disable-runuser --disable-pylibmount --disable-static --without-python --without-systemd --without-systemdsystemunitdir --without-ncurses
  make prlimit
  popd
 # remove the limit on locked memory for this process
 - (test "$TRAVIS_OS_NAME" = "linux" && sudo $PWD/util-linux-2.25.2/prlimit --pid "$$" --memlock=unlimited:unlimited) || true
 - |
  set -e
  ulimit -a
  jackd -r -p12 -ddummy -r48000 -p4096 -w100000 -P0 -C0 &
  sleep 5
  julia -e 'Pkg.clone(pwd()); Pkg.build("JACKAudio"); Pkg.test("JACKAudio"; coverage=true)'
  killall jackd
after_success:
  - julia -e 'cd(Pkg.dir("JACKAudio")); Pkg.add("Coverage"); using Coverage; Codecov.submit(process_folder())'
